# Continuous Deployment Workflow
#
# Deploys the application to Aptible on push to main branch.
# Requires CI checks to pass before deployment.
#
# Required Secrets:
#   - APTIBLE_USERNAME: Aptible account email
#   - APTIBLE_PASSWORD: Aptible account password
#
# Aptible Apps:
#   - daybreak-api-production (backend)
#   - daybreak-frontend-production (frontend)
#

name: Deploy

on:
  push:
    branches: [master, main]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  APTIBLE_ENVIRONMENT: daybreak-onboarding

jobs:
  # ==========================================================================
  # Run CI First
  # ==========================================================================
  ci:
    name: Run CI
    uses: ./.github/workflows/ci.yml

  # ==========================================================================
  # Deploy Backend to Aptible
  # ==========================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: ci
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare backend for deploy
        run: |
          git config user.email "deploy@github-actions"
          git config user.name "GitHub Actions"
          # Move backend to root, remove everything else
          shopt -s dotglob
          mv backend/* .
          rm -rf backend frontend _docs scripts docker-compose.yml Makefile README.md || true
          git add -A
          git commit -m "Prepare backend for Aptible deploy" --allow-empty

      - name: Deploy to Aptible
        uses: aptible/aptible-deploy-action@v5
        with:
          type: git
          app: daybreak-api-production
          environment: ${{ env.APTIBLE_ENVIRONMENT }}
          username: ${{ secrets.APTIBLE_USERNAME }}
          password: ${{ secrets.APTIBLE_PASSWORD }}

      - name: Notify deployment success
        if: success()
        run: echo "Backend deployed successfully to ${{ env.APTIBLE_ENVIRONMENT }}"

  # ==========================================================================
  # Deploy Frontend to Aptible
  # ==========================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: ci
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare frontend for deploy
        run: |
          git config user.email "deploy@github-actions"
          git config user.name "GitHub Actions"
          # Move frontend to root, remove everything else
          shopt -s dotglob
          mv frontend/* .
          rm -rf backend frontend _docs scripts docker-compose.yml Makefile README.md || true
          git add -A
          git commit -m "Prepare frontend for Aptible deploy" --allow-empty

      - name: Deploy to Aptible
        uses: aptible/aptible-deploy-action@v5
        with:
          type: git
          app: daybreak-frontend-production
          environment: ${{ env.APTIBLE_ENVIRONMENT }}
          username: ${{ secrets.APTIBLE_USERNAME }}
          password: ${{ secrets.APTIBLE_PASSWORD }}

      - name: Notify deployment success
        if: success()
        run: echo "Frontend deployed successfully to ${{ env.APTIBLE_ENVIRONMENT }}"

  # ==========================================================================
  # Post-deployment verification
  # ==========================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()

    steps:
      - name: Wait for services to start
        run: sleep 60

      - name: Deployment complete
        run: |
          echo "Deployment to ${{ env.APTIBLE_ENVIRONMENT }} completed!"
          echo "Verify endpoints in Aptible dashboard"
          echo "Backend app: daybreak-api-production"
          echo "Frontend app: daybreak-frontend-production"
